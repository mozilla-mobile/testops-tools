pipeline {
    agent any

    parameters {
        booleanParam(name: 'DRY_RUN', defaultValue: false, description: 'Enable dry-run mode (no git commit/push)')
    }

    triggers {
        // Run every hour on weekdays (Monday-Friday)
        cron('H * * * 1-5')
    }

    environment {
        GH_TOKEN = credentials('github-token')
        BITRISE_APP_ID = credentials('bitrise-app-id')
        JENKINS_URL = "${env.JENKINS_URL}"
        JENKINS_USER = credentials('jenkins-user')
        JENKINS_API_TOKEN = credentials('jenkins-api-token')
        JENKINS_JOB_NAME = 'create-milestone'  // Update this to match your Jenkins job name
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Setup Python') {
            steps {
                sh '''
                    # Check if Python 3 is available
                    if ! command -v python3 &> /dev/null; then
                        echo "Python 3 is not installed. Please install Python 3.11 or higher."
                        exit 1
                    fi

                    python3 --version

                    # Ensure pip is available
                    if ! command -v pip3 &> /dev/null; then
                        echo "pip3 is not installed. Installing pip..."
                        python3 -m ensurepip --upgrade || curl https://bootstrap.pypa.io/get-pip.py | python3
                    fi

                    pip3 --version
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                dir('testrail') {
                    sh 'pip3 install --no-cache-dir -r requirements.txt'
                }
            }
        }

        stage('Run Bitrise Tag Checker') {
            steps {
                dir('testrail') {
                    sh 'python3 check_bitrise_for_release.py'
                }
            }
        }

        stage('Commit and Push Changes') {
            when {
                expression { params.DRY_RUN == false }
            }
            steps {
                script {
                    // Configure git user for commits
                    sh '''
                        git config --global user.name 'jenkins-automation'
                        git config --global user.email 'jenkins@automation.local'
                        git add testrail/latest_tags.json
                    '''

                    // Only commit and push if there are changes
                    def gitStatus = sh(script: 'git diff --staged --quiet', returnStatus: true)
                    if (gitStatus != 0) {
                        withCredentials([usernamePassword(credentialsId: 'github-token',
                                                          usernameVariable: 'GIT_USERNAME',
                                                          passwordVariable: 'GIT_PASSWORD')]) {
                            sh '''
                                git commit -m 'Automated update of latest_tags'

                                # Extract repo URL and add credentials
                                REPO_URL=$(git config --get remote.origin.url)

                                # If using HTTPS, inject credentials
                                if [[ $REPO_URL == https://* ]]; then
                                    REPO_URL=$(echo $REPO_URL | sed "s|https://|https://${GIT_USERNAME}:${GIT_PASSWORD}@|")
                                fi

                                git push $REPO_URL HEAD:${GIT_BRANCH}
                            '''
                        }
                        echo 'Changes committed and pushed successfully'
                    } else {
                        echo 'No changes to commit'
                    }
                }
            }
        }

        stage('Dry Run Summary') {
            when {
                expression { params.DRY_RUN == true }
            }
            steps {
                script {
                    echo '===================================='
                    echo 'DRY RUN MODE ENABLED'
                    echo '===================================='
                    echo 'The following changes would be committed:'
                    sh 'git diff testrail/latest_tags.json || echo "No changes detected"'
                    echo '===================================='
                    echo 'No commit or push was performed'
                    echo '===================================='
                }
            }
        }
    }

    post {
        success {
            echo 'Successfully checked Bitrise tags and updated repository'
        }
        failure {
            echo 'Failed to check Bitrise tags'
        }
        cleanup {
            cleanWs()
        }
    }
}
