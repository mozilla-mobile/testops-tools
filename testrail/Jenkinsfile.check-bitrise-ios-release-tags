pipeline {
    agent any

    options {
        timestamps()
    }

    triggers {
        cron('H * * * 1-5')
    }

    environment {
        PATH = "/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/opt/homebrew/bin:${env.PATH}"
        GH_TOKEN = credentials('github-token')
        BITRISE_APP_ID = credentials('bitrise-app-id')
        JENKINS_URL = "${env.JENKINS_URL}"
        JENKINS_CREDS = credentials('jenkins-user')  // Username with password credential
        JENKINS_USER = "${JENKINS_CREDS_USR}"
        JENKINS_API_TOKEN = "${JENKINS_CREDS_PSW}"
        JENKINS_JOB_NAME = 'create-milestone'
        SLACK_WEBHOOK = credentials('slack-mobile-alerts-tooling-webhook')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Setup Python') {
            steps {
                sh '''
                    set -e
                    echo "Checking Python installation..."
                    python3 --version
                    echo "Checking pip installation..."
                    python3 -m pip --version
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                dir('testrail') {
                    sh 'pip3 install --no-cache-dir -r requirements.txt'
                }
            }
        }

        stage('Run Bitrise Tag Checker') {
            steps {
                dir('testrail') {
                    sh 'python3 check_bitrise_for_release.py'
                }
            }
        }

        stage('Commit and Push Changes') {
            when {
                expression {
                    // Only run if latest_tags.json was modified by the script
                    def changed = sh(script: 'git diff --quiet testrail/latest_tags.json', returnStatus: true)
                    if (changed != 0) {
                        echo "✅ New version detected - latest_tags.json was modified"
                        return true
                    } else {
                        echo "ℹ️  No new versions detected - skipping commit and push"
                        return false
                    }
                }
            }
            steps {
                script {
                    sh '''
                        set -e
                        git config --global user.name 'jenkins-automation'
                        git config --global user.email 'jenkins@automation.local'
                        git add testrail/latest_tags.json
                    '''
                    withCredentials([usernamePassword(credentialsId: 'github-token',
                                                      usernameVariable: 'GIT_USERNAME',
                                                      passwordVariable: 'GIT_TOKEN')]) {
                        sh '''
                            set -e
                            git commit -m 'Automated update of latest_tags'
                            REPO_URL=$(git config --get remote.origin.url)
                            if [[ $REPO_URL == https://* ]]; then
                                # Use only token for GitHub (avoids @ in username issues)
                                REPO_URL=$(echo $REPO_URL | sed "s|https://|https://${GIT_TOKEN}@|")
                            fi
                            # Push to main branch (Jenkins runs in detached HEAD state)
                            git push $REPO_URL HEAD:refs/heads/main
                        '''
                    }
                    echo 'Changes committed and pushed successfully'
                }
            }
        }
    }

    post {
        fixed {
            // Pipeline recovered: was failing, now passing
            script {
                sh """
                    curl -X POST ${SLACK_WEBHOOK} \
                    -H 'Content-Type: application/json' \
                    -d '{
                        "text": ":white_check_mark: *RECOVERED*: ${env.JOB_NAME}",
                        "attachments": [{
                            "color": "good",
                            "fields": [
                                {"title": "Job", "value": "${env.JOB_NAME}", "short": true},
                                {"title": "Build", "value": "#${env.BUILD_NUMBER}", "short": true},
                                {"title": "Status", "value": "SUCCESS (was FAILURE)", "short": false},
                                {"title": "Console", "value": "<${env.BUILD_URL}console|View Logs>", "short": false}
                            ]
                        }]
                    }'
                """
            }
            echo '✅ Successfully checked Bitrise tags and updated repository (RECOVERED)'
        }

        regression {
            // Pipeline regressed: was passing, now failing
            script {
                sh """
                    curl -X POST ${SLACK_WEBHOOK} \
                    -H 'Content-Type: application/json' \
                    -d '{
                        "text": ":x: *REGRESSION*: ${env.JOB_NAME}",
                        "attachments": [{
                            "color": "danger",
                            "fields": [
                                {"title": "Job", "value": "${env.JOB_NAME}", "short": true},
                                {"title": "Build", "value": "#${env.BUILD_NUMBER}", "short": true},
                                {"title": "Status", "value": "FAILURE (was SUCCESS)", "short": false},
                                {"title": "Console", "value": "<${env.BUILD_URL}console|View Logs>", "short": false}
                            ]
                        }]
                    }'
                """
            }
            echo '❌ Failed to check Bitrise tags (REGRESSION)'
        }

        success {
            echo 'Successfully checked Bitrise tags and updated repository'
        }

        failure {
            echo 'Failed to check Bitrise tags'
        }

        cleanup {
            cleanWs()
        }
    }
}
