pipeline {
    agent any

    options {
        timestamps()
    }

    environment {
        PATH = "/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/opt/homebrew/bin:${env.PATH}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Test Git Push with Token') {
            steps {
                script {
                    // Create a test file to commit
                    sh '''
                        set -e
                        echo "Test commit at $(date)" > testrail/test-push.txt
                        git config --global user.name 'jenkins-automation'
                        git config --global user.email 'jenkins@automation.local'
                        git add testrail/test-push.txt
                    '''

                    // Test the new authentication method
                    withCredentials([usernamePassword(credentialsId: 'github-token',
                                                      usernameVariable: 'GIT_USERNAME',
                                                      passwordVariable: 'GIT_TOKEN')]) {
                        sh '''
                            set -e
                            git commit -m 'Test: git push con token'

                            # Create test branch with timestamp
                            TEST_BRANCH="test-git-push-$(date +%Y%m%d-%H%M%S)"
                            echo "üß™ Testing push to branch: ${TEST_BRANCH}"

                            # DEBUG: Check what we have (token will be masked by Jenkins)
                            echo "DEBUG: Username = ${GIT_USERNAME}"
                            echo "DEBUG: Token length = ${#GIT_TOKEN}"

                            # Configure git to use token via credential helper
                            # The helper must consume stdin before outputting credentials
                            git config --local credential.helper '!f() {
                                while IFS= read -r line; do
                                    test -z "$line" && break
                                done
                                echo "username=${GIT_USERNAME}"
                                echo "password=${GIT_TOKEN}"
                            }; f'

                            # Enable git credential debug
                            GIT_TRACE=1 GIT_CURL_VERBOSE=1 git push https://github.com/mozilla-mobile/testops-tools.git "HEAD:refs/heads/${TEST_BRANCH}"

                            echo "‚úÖ Successfully pushed to test branch: ${TEST_BRANCH}"
                            echo "üîó View at: https://github.com/mozilla-mobile/testops-tools/tree/${TEST_BRANCH}"
                        '''
                    }
                    echo '‚úÖ Git push test completed successfully!'
                }
            }
        }
    }

    post {
        success {
            echo '‚úÖ Test passed - git push with token works!'
        }

        failure {
            echo '‚ùå Test failed - check the logs for errors'
        }

        cleanup {
            cleanWs()
        }
    }
}
