name: Check Bitrise Firefox iOS Tags

on:
  schedule:
    - cron: "0 * * * 1-5"  # every hour
  workflow_dispatch:

jobs:
  check-bitrise:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r testrail/requirements.txt
      
      - name: Pull latest remote changes
        run: git pull --rebase

      - name: Run Bitrise tag checker
        run: python testrail/check_bitrise_for_release.py
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BITRISE_APP_ID: ${{ secrets.BITRISE_APP_ID }}
        
      - name: Commit and push updated last_tag.txt
        env:
          WEBHOOK_CHANNEL: ${{ secrets.WEBHOOK_SLACK_MOBILE_TESTENG_CHANNEL }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'

          git add last_tag.txt

          if git diff --cached --quiet; then
            echo "ðŸŸ¢ No changes to commit"
          else
            BRANCH_NAME=update-last-tag-${GITHUB_RUN_ID}
            git checkout -b $BRANCH_NAME

            git commit -m "Update last_tag.txt [skip ci]"
            git push origin $BRANCH_NAME

            PR_URL=$(gh pr create --title "Update last_tag.txt" \
                --body "File uploaded automaticaclly." \
                --head $BRANCH_NAME \
                --base ${{ github.event.repository.default_branch }} \
                --label automation)

            echo "âœ… PR creado: $PR_URL"

            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"ðŸš¨ *IMPORTANT*: iOS Milestone created. \nReview and approve the Pull Request: <$PR_URL|See PR>\"}" \
              "$WEBHOOK_CHANNEL"            
          fi
