name: Detect firefox-ios XCUITests missing TestRail URL (Slack)

permissions: read-all

on:
  schedule:
    - cron: "0 8 * * 1"
  workflow_dispatch: {}
  workflow_call:
    secrets:
      SLACK_WEBHOOK_URL_TEST_ALERTS_SANDBOX:
        required: true

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout testops-tools
        uses: actions/checkout@v4

      - name: Checkout firefox-ios
        uses: actions/checkout@v4
        with:
          repository: mozilla-mobile/firefox-ios
          path: firefox-ios
          fetch-depth: 1
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set job log URL
        if: always()
        run: |
          echo "JOB_LOG_URL=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_ENV

      - name: Run detector (auto-discover root) and prepare Slack content
        id: scan
        shell: bash
        run: |
          set -euo pipefail

          DOMAIN="mozilla.testrail.io"

          FOUND_ROOT=$(find firefox-ios -type d -iname '*XCUITests*' -print -quit || true)
          if [ -z "$FOUND_ROOT" ]; then
            echo "ERROR: could not find an XCUITests directory under firefox-ios"
            echo "Contents of firefox-ios top-level:"
            ls -la firefox-ios || true
            exit 2
          fi

          echo "Using discovered ROOT: $FOUND_ROOT"
          echo "ROOT=$FOUND_ROOT" >> $GITHUB_ENV

          # Run the script
          python testrail/testrail_scan_missing_urls.py \
            --root "$FOUND_ROOT" \
            --testrail-domain "$DOMAIN" \
            > testrail_missing_report.txt

          # Extract the test lines
          grep -E '^- ' testrail_missing_report.txt > missing_items.txt || true

          MISSING_COUNT=$(wc -l < missing_items.txt | tr -d ' ')
          echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT
          echo "MISSING_COUNT=$MISSING_COUNT" >> $GITHUB_ENV

          # Build a compact Slack list (test names only) to avoid Slack payload limits
          MAX_LINES=15
          if [ "$MISSING_COUNT" -gt 0 ]; then
            head -n "$MAX_LINES" missing_items.txt \
              | sed 's/^.*  //' \
              | awk '{print "â€¢ " $0}' \
              > missing_bullets.txt

            if [ "$MISSING_COUNT" -gt "$MAX_LINES" ]; then
              echo "â€¢ â€¦and $((MISSING_COUNT - MAX_LINES)) more (see workflow run)" >> missing_bullets.txt
            fi
          else
            echo "None ðŸŽ‰" > missing_bullets.txt
          fi

      - name: Prepare Slack-safe list (escape newlines)
        if: ${{ steps.scan.outputs.missing_count != '0' && !cancelled() }}
        shell: bash
        run: |
          set -euo pipefail
          # Convert literal newlines into "\n" so JSON templating remains valid
          LIST=$(python -c "import sys; print(sys.stdin.read().replace('\n','\\\\n').strip())" < missing_bullets.txt)
          echo "MISSING_LIST_ESCAPED=$LIST" >> $GITHUB_ENV

      - name: Publish summary (visible in GitHub UI)
        if: always()
        shell: bash
        run: |
          {
            echo "## TestRail URL check (XCUITests)"
            echo ""
            echo "- **Missing count:** ${MISSING_COUNT:-0}"
            echo "- **Repo scanned:** mozilla-mobile/firefox-ios"
            echo "- **Root:** ${ROOT:-<unknown>}"
            echo "- **Workflow run:** ${JOB_LOG_URL}"
            echo ""

            if [ -f missing_items.txt ] && [ "$(wc -l < missing_items.txt | tr -d ' ')" -gt 0 ]; then
              echo "### Tests missing TestRail URL"
              echo ""
              echo "> Showing up to 50 test names"
              echo ""
              echo '```'
              head -n 50 missing_items.txt | sed 's/^.*  //'
              echo '```'
            else
              echo "âœ… No missing TestRail URLs found."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Send Slack notification (only if missing links exist)
        if: ${{ steps.scan.outputs.missing_count != '0' && !cancelled() }}
        uses: slackapi/slack-github-action@v2.0.0
        with:
          payload-file-path: ".github/slack/testrail-missing-links.json"
          payload-templated: true
          webhook: ${{ secrets.SLACK_WEBHOOK_URL_TEST_ALERTS_SANDBOX }}
          webhook-type: incoming-webhook
          errors: true
